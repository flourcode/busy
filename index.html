<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#000000">
    <title>Busy Towers</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        /* Imports our custom fonts from Google Fonts */
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        /* Basic page reset */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        /* **** NEW: Ensure HTML fills the screen and safe areas **** */
        html {
            height: 100vh;
            height: 100dvh; /* Dynamic viewport - adjusts for browser chrome */
            background: #000;
        }

        /* Sets the default font, background color, and prevents scrolling */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'SF Pro Display', sans-serif;
            background: #000;
            color: #fff;
            overflow: hidden; /* This hides scrollbars */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            height: 100vh;
            height: 100dvh; /* Dynamic viewport - adjusts for browser chrome */
            position: fixed; /* Prevents mobile browser bounce/scroll */
            width: 100%;
        }

        /* This is the map container. It fills the entire screen. */
        #map {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            height: 100dvh; /* Dynamic viewport - adjusts for browser chrome */
        }

        /* This styles the header bar at the top of the screen */
        #header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000; /* Ensures the header is above the map */
            background: linear-gradient(180deg, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0) 100%);
            padding: 24px 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: opacity 0.5s ease;
        }

        /* This styles the "Busy Towers" title */
        .logo {
            font-size: 17px;
            font-weight: 600;
            letter-spacing: -0.4px;
            color: rgba(255, 255, 255, 0.95);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* This styles the "• X aircraft" count */
        .logo .count {
            font-size: 14px;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.6);
            font-family: 'Roboto Mono', monospace; /* Uses our special "data" font */
        }

        /* This styles the airport dropdown selector */
        .airport-selector {
            background: #111;
            border: 0.5px solid #333;
            border-radius: 10px;
            padding: 8px 16px;
            color: #fff;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            outline: none;
            transition: all 0.2s ease;
        }

        .airport-selector:hover {
            background: #222;
        }

        /* This styles the options inside the dropdown */
        .airport-selector option {
            background: #1c1c1e;
        }

        /* This styles the pop-up info box for the selected aircraft */
        .aircraft-info {
            position: fixed;
            bottom: 32px;
            left: 50%;
            transform: translateX(-50%); /* This centers the box */
            background: #111;
            border: 0.5px solid #333;
            border-radius: 16px;
            padding: 20px 28px;
            min-width: 320px;
            opacity: 0; /* Hidden by default */
            pointer-events: none; /* Can't be clicked when hidden */
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 900;
        }

        /* This class is added by JavaScript to show the info box */
        .aircraft-info.visible {
            opacity: 1;
            pointer-events: all;
        }

        /* Styles the callsign (e.g., "CKS813") in the info box */
        .aircraft-info .callsign {
            font-size: 24px;
            font-weight: 500;
            letter-spacing: -0.5px;
            margin-bottom: 4px;
            font-family: 'Roboto Mono', monospace;
        }

        /* Styles the aircraft type (e.g., "B744") in the info box */
        .aircraft-info .type {
            font-size: 18px;
            font-weight: 500;
            letter-spacing: -0.5px;
            margin-bottom: 4px;
            font-family: 'Roboto Mono', monospace;
        }

        /* This creates the 3-column layout for the stats */
        .aircraft-info .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .aircraft-info .stat {
            text-align: center;
        }

        /* Styles the stat numbers (e.g., "3,900 ft") */
        .aircraft-info .stat-value {
            font-size: 18px;
            font-weight: 500;
            font-variant-numeric: tabular-nums;
            margin-bottom: 2px;
            font-family: 'Roboto Mono', monospace;
        }

        /* Styles the stat labels (e.g., "Altitude") */
        .aircraft-info .stat-label {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.5);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* This styles the "Listen to ATC" button */
        .audio-control {
            position: fixed;
            bottom: 32px;
            left: 32px;
            background: #111;
            border: 0.5px solid #333;
            border-radius: 12px;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            z-index: 900;
            font-size: 14px;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.9);
        }

        .audio-control:hover {
            background: #222;
            transform: translateY(-2px);
        }

        /* This class is added by JavaScript when audio is playing */
        .audio-control.playing {
            background: rgba(0, 122, 255, 0.9);
            border-color: rgba(0, 122, 255, 0.3);
            color: #fff;
        }

        .audio-control svg {
            width: 16px;
            height: 16px;
            fill: currentColor;
        }

        /* This styles the legend box in the top-right */
        .legend {
            position: fixed;
            top: 90px;
            right: 32px;
            background: #111;
            border: 0.5px solid #333;
            border-radius: 12px;
            padding: 16px;
            z-index: 900;
            min-width: 160px;
        }

        .legend .title {
            font-size: 11px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.6);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }

        .legend .item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
            font-size: 13px;
        }

        .legend .item:last-child {
            margin-bottom: 0;
        }
        
        /* Styles for the icons in the new legend */
        .legend .icon {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }

        /* Style for the text-based infinity icon in the legend */
        .legend .icon-text {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
            text-align: center;
            font-size: 24px;
            font-weight: 500;
            line-height: 20px; /* Aligns infinity symbol vertically */
        }

        .legend .label {
            color: rgba(255, 255, 255, 0.9);
            font-weight: 500;
        }

        /*
         * **** MODIFIED: Theme Toggle Button ****
         * This styles the new Day/Night toggle button
        */
        .theme-toggle {
            position: fixed;
            bottom: 160px; /* Positioned above the recenter button */
            left: 32px;
            background: #111;
            border: 0.5px solid #333;
            border-radius: 12px;
            padding: 10px 16px; /* Adjusted padding for text */
            cursor: pointer;
            transition: all 0.2s ease;
            z-index: 900;
            color: rgba(255, 255, 255, 0.9);
            font-size: 13px; /* Matched recenter button */
            font-weight: 500; /* Matched recenter button */
        }

        .theme-toggle:hover {
            background: #222;
            transform: translateY(-2px);
        }
        /* **** END MODIFIED **** */


        /* This styles the "Recenter" button */
        .recenter-button {
            position: fixed;
            bottom: 100px;
            left: 32px;
            background: #111;
            border: 0.5px solid #333;
            border-radius: 12px;
            padding: 10px 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            z-index: 900;
            font-size: 13px;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .recenter-button:hover {
            background: #222;
            transform: translateY(-2px);
        }

        /* This is the base style for all aircraft icons */
        .plane-marker {
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .plane-marker svg {
            filter: drop-shadow(0 2px 8px rgba(0, 0, 0, 0.4));
        }

        /* Style for the text-based helicopter icon on the map */
        .plane-marker .icon-heli {
            font-size: 28px;
            font-weight: 500;
            line-height: 1;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }

        /* This makes the aircraft trails fade in/out smoothly */
        .leaflet-overlay-pane svg path {
            transition: stroke 0.5s ease;
        }

        /*
         * **** MODIFIED: Map Attribution ****
         * This styles the map attribution (e.g., "© OpenStreetMap")
         * It now supports both light and dark modes.
        */
        .leaflet-control-attribution {
            background: rgba(0, 0, 0, 0.5) !important;
            color: rgba(255, 255, 255, 0.5) !important;
            font-size: 10px !important;
            padding: 4px 8px !important;
            border-radius: 4px !important;
        }

        .leaflet-control-attribution a {
            color: rgba(255, 255, 255, 0.7) !important;
        }

        /* This rule overrides the attribution for the light theme */
        body.theme-light .leaflet-control-attribution {
            background: rgba(255, 255, 255, 0.7) !important;
            color: rgba(0, 0, 0, 0.7) !important;
        }
        body.theme-light .leaflet-control-attribution a {
            color: #000 !important;
        }


        /*
         * **** MODIFICATION: AIRCRAFT TYPE COLORS & STYLES ****
         * These classes control the icon style (fill/stroke) and the trail color.
        */
        
        /* -- Trail Colors -- */
        .trail-comm  { stroke: #0a84ff; }
        .trail-ga    { stroke: #30d158; }
        .trail-mil   { stroke: #ff375f; }
        .trail-heli  { stroke: #ff9f0a; }
        .trail-other { stroke: #a2a2d2; }

        /* -- Icon Styles -- */
        /* **** MODIFIED: Added a stroke to .icon-comm to match the visual weight **** */
        .icon-comm  { fill: #0a84ff; stroke: #0a84ff; stroke-width: 1px; } /* Commercial: FILLED + OUTLINE */
        .icon-ga    { fill: none; stroke: #30d158; stroke-width: 1px; } /* GA: OUTLINE */
        .icon-mil   { fill: none; stroke: #ff375f; stroke-width: 1px; } /* Military: OUTLINE */
        .icon-other { fill: none; stroke: #a2a2d2; stroke-width: 1px; } /* Other: OUTLINE */
        .icon-heli  { color: #ff9f0a; } /* Helicopter: TEXT COLOR */


        /* These styles make the UI responsive on smaller (mobile) screens */
        @media (max-width: 768px) {
            #header {
                padding: 20px 20px;
            }

            .aircraft-info {
                bottom: 20px;
                left: 20px;
                right: 20px;
                transform: none;
                min-width: auto;
            }

            .audio-control {
                bottom: 20px;
                left: 20px;
                padding: 10px 16px;
                font-size: 13px;
            }
            
            /* **** MODIFIED: Position theme toggle on mobile **** */
            .theme-toggle {
                bottom: 140px; /* Stacked above recenter */
                left: 20px;
                padding: 8px 14px; /* Matched recenter button */
                font-size: 12px;
            }

            .recenter-button {
                bottom: 80px;
                left: 20px;
                padding: 8px 14px;
                font-size: 12px;
            }

            /* Move legend to the bottom on mobile to avoid zoom controls */
            .legend {
                top: auto;
                bottom: 20px;
                right: 20px;
                padding: 12px;
                min-width: 140px;
            }

            .legend .title {
                font-size: 10px;
                margin-bottom: 10px;
            }
            
            .legend .item {
                font-size: 12px;
                margin-bottom: 6px;
            }
        }
    </style>
</head>
<body>
    <div id="header">
        <div class="logo">
            <span>Busy Towers</span>
            <span class="count" id="aircraft-count">• 0 aircraft</span>
        </div>
        
        <select id="airport-selector" class="airport-selector">
            <option value="JFK" selected>JFK</option>
			<option value="ATL">ATL</option>
            <option value="DEN">DEN</option>
            <option value="LAX">LAX</option>
            <option value="SEA">SEA</option>
            <option value="IAD">IAD</option>
            </select>
    </div>

    <div id="map"></div>

    <div class="legend">
        <div class="title">Aircraft Type</div>
        <div class="item">
            <svg class="icon icon-comm" viewBox="0 0 24 24">
                <path d="M21,16v-2l-8-5V3.5C13,2.67,12.33,2,11.5,2S10,2.67,10,3.5V9l-8,5v2l8-2.5V19l-2,1.5V22l3.5-1l3.5,1v-1.5L13,19v-5.5L21,16z"/>
            </svg>
            <div class="label">Commercial</div>
        </div>
        <div class="item">
            <svg class="icon icon-ga" viewBox="0 0 24 24">
                <path d="M21,16v-2l-8-5V3.5C13,2.67,12.33,2,11.5,2S10,2.67,10,3.5V9l-8,5v2l8-2.5V19l-2,1.5V22l3.5-1l3.5,1v-1.5L13,19v-5.5L21,16z"/>
            </svg>
            <div class="label">Gen. Aviation</div>
        </div>
        <div class="item">
            <svg class="icon icon-mil" viewBox="0 0 24 24">
                <path d="M21,16v-2l-8-5V3.5C13,2.67,12.33,2,11.5,2S10,2.67,10,3.5V9l-8,5v2l8-2.5V19l-2,1.5V22l3.5-1l3.5,1v-1.5L13,19v-5.5L21,16z"/>
            </svg>
            <div class="label">Military</div>
        </div>
        <div class="item">
            <span class="icon-text icon-heli">&infin;</span>
            <div class="label">Helicopter</div>
        </div>
    </div>


    <div id="theme-toggle" class="theme-toggle" title="Toggle Map Theme">
        <span id="theme-toggle-text">Day</span>
    </div>

    <div id="recenter-button" class="recenter-button">
        <span>RECENTER</span>
    </div>

    <div id="aircraft-info" class="aircraft-info">
        <div class="callsign" id="info-callsign">—</div>
        <div class="type" id="info-type">—</div>
        <div class="stats">
            <div class="stat">
                <div class="stat-value" id="info-altitude">—</div>
                <div class="stat-label">Altitude</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="info-speed">—</div>
                <div class="stat-label">Speed</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="info-status">—</div>
                <div class="stat-label">Status</div>
            </div>
        </div>
    </div>

    <div id="audio-control" class="audio-control">
        <svg id="audio-icon" viewBox="0 0 24 24">
            <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/>
        </svg>
        <span id="audio-text">Listen to ATC</span>
    </div>

    <audio id="audio" preload="none"></audio>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // --- SECTION 1: GLOBAL SETTINGS & VARIABLES ---

        /*
         * MODIFICATION: AIRPORT LIST
         * This is the main list of airports. To add one:
         * 1. Add a new line here (e.g., "YOUR_CODE": { ... }).
         * 2. Find coordinates (e.g., Google "LAX coordinates").
         * 3. Find an ATC audio stream (e.g., from LiveATC.net).
         * 4. Add the matching "<option>" tag in the HTML dropdown above.
        */
        const AIRPORTS = {
            IAD: { name: 'IAD', lat: 38.9531, lon: -77.4565, zoom: 10, audio: 'https://d.liveatc.net/kiad1_7' },
            JFK: { name: 'JFK', lat: 40.6413, lon: -73.7781, zoom: 10, audio: 'https://d.liveatc.net/kjfk9_s' },
            ATL: { name: 'ATL', lat: 33.6407, lon: -84.4277, zoom: 10, audio: 'https://d.liveatc.net/katl_twr' },
            DEN: { name: 'DEN', lat: 39.8561, lon: -104.6737, zoom: 10, audio: 'https://d.liveatc.net/kden1_6' },
            LAX: { name: 'LAX', lat: 33.9416, lon: -118.4085, zoom: 10, audio: 'https://d.liveatc.net/klax6' },
			SEA: { name: 'SEA', lat: 47.4502, lon: -122.3088, zoom: 10, audio: 'https://d.liveatc.net/ksea3_gnd' }
        };
        
        /*
         * **** UPDATED: Map Tile URLs ****
         * Changed the LIGHT_MAP_URL to the standard OpenStreetMap.
        */
        const LIGHT_MAP_URL = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
        const DARK_MAP_URL = 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png';


        // **** UPDATED: We only need one plane icon path now ****
        // This is the standard commercial airliner icon
        const PATH_COMMERCIAL = "M21,16v-2l-8-5V3.5C13,2.67,12.33,2,11.5,2S10,2.67,10,3.5V9l-8,5v2l8-2.5V19l-2,1.5V22l3.5-1l3.5,1v-1.5L13,19v-5.5L21,16z";

        // This variable keeps track of which airport is currently selected
        let currentAirport = 'JFK'; // Default airport on load
        let currentTheme = 'dark';  // Default theme on load

        // These variables are placeholders to store our map and aircraft data
        let map; // The Leaflet map object
        let tileLayer; // The Leaflet tile layer object
        let aircraftData = new Map(); // Stores the raw data for all aircraft
        let markers = new Map();      // Stores the clickable icon (marker) for each aircraft
        let trails = new Map();       // Stores the path (trail) for each aircraft
        let trailLines = new Map();   // Stores the visual line object for each trail

        let selectedAircraft = null; // Stores the ID of the aircraft you clicked on
        let airportMarker = null;    // Stores the clickable icon for the airport
        let isFollowing = false;     // True if the map is currently panning to follow a plane

        // --- SECTION 2: CORE FUNCTIONS ---

        /**
         * This is the main function that runs when the page first loads.
         * It sets everything up.
         */
        function init() {
            // Makes the dropdown menu match the default airport ('JFK')
            document.getElementById('airport-selector').value = currentAirport;
            // Sets the browser tab title
            document.title = "Busy Towers";
            
            // Mobile fullscreen: Hide address bar on load
            setTimeout(() => {
                window.scrollTo(0, 1);
            }, 100);
            
            // Re-hide address bar on orientation change
            window.addEventListener('orientationchange', () => {
                setTimeout(() => {
                    window.scrollTo(0, 1);
                }, 100);
            });
            
            // Calls all the other setup functions
            initMap();
            startTracking();
            autoHideHeader();
            autoStartAudio();
            
            // Connects the "Listen to ATC" button to its function
            document.getElementById('audio-control').addEventListener('click', toggleAudio);
            
            // Connects the "Recenter" button to its function
            document.getElementById('recenter-button').addEventListener('click', recenterView);

            // **** NEW: Connect the Theme Toggle button ****
            document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
        }

        /**
         * Creates the map, adds the map tiles, and places the first
         * airport marker.
         */
        function initMap() {
            const airport = AIRPORTS[currentAirport];
            
            // Create the map object, centered on the current airport
            map = L.map('map', {
                center: [airport.lat, airport.lon],
                zoom: airport.zoom,
                zoomControl: false,
                attributionControl: true
            });

            /*
             * MODIFICATION: MAP TILES
             * This now uses the global `tileLayer` variable so we
             * can change the URL later.
            */
            tileLayer = L.tileLayer(DARK_MAP_URL, {
                attribution: '© OpenStreetMap contributors',
                maxZoom: 19
            });
            tileLayer.addTo(map);

            // Create the white circle icon for the airport
            const airportIcon = L.divIcon({
                html: `
                    <div style="text-align: center;">
                        <svg width="32" height="32" viewBox="0 0 32 32">
                            <circle cx="16" cy="16" r="12" fill="rgba(255,255,255,0.15)" stroke="rgba(255,255,255,0.9)" stroke-width="2"/>
                            <circle cx="16" cy="16" r="4" fill="rgba(255,255,255,0.9)"/>
                        </svg>
                        <div style="background: #111; border: 0.5px solid #333; color: white; font-size: 11px; font-weight: 600; padding: 4px 8px; border-radius: 6px; margin-top: 2px; white-space: nowrap;">${airport.name}</div>
                    </div>
                `,
                className: '',
                iconSize: [80, 60],
                iconAnchor: [40, 30]
            });
            airportMarker = L.marker([airport.lat, airport.lon], { icon: airportIcon }).addTo(map);

            // Adds the +/- zoom buttons to the bottom-right
            L.control.zoom({ position: 'bottomright' }).addTo(map);

            // Listens for a change on the dropdown menu
            document.getElementById('airport-selector').addEventListener('change', (e) => {
                changeAirport(e.target.value);
            });
        }
        
        /**
         * **** MODIFIED: Theme Toggle Function ****
         * Toggles the map theme and updates the button text.
         */
        function toggleTheme() {
            const themeText = document.getElementById('theme-toggle-text');
            if (currentTheme === 'dark') {
                currentTheme = 'light';
                tileLayer.setUrl(LIGHT_MAP_URL); // Set to light map URL
                document.body.classList.add('theme-light'); // Add class for CSS
                themeText.textContent = 'DARK'; // Update button text
            } else {
                currentTheme = 'dark';
                tileLayer.setUrl(DARK_MAP_URL); // Set to dark map URL
                document.body.classList.remove('theme-light'); // Remove class
                themeText.textContent = 'LIGHT'; // Update button text
            }
        }

        /**
         * Called when you select a new airport from the dropdown.
         * It moves the map, clears old data, and changes the audio.
         */
        function changeAirport(code) {
            isFollowing = false; // Stop following any plane
            currentAirport = code;
            const airport = AIRPORTS[code];
            
            // Move the map to the new airport's coordinates
            map.setView([airport.lat, airport.lon], airport.zoom);
            
            // Remove the old airport's marker
            if (airportMarker) {
                map.removeLayer(airportMarker);
            }
            
            // Create a new marker for the new airport
            const airportIcon = L.divIcon({
                html: `
                    <div style="text-align: center;">
                        <svg width="32" height="32" viewBox="0 0 32 32">
                            <circle cx="16" cy="16" r="12" fill="rgba(255,255,255,0.15)" stroke="rgba(255,255,255,0.9)" stroke-width="2"/>
                            <circle cx="16" cy="16" r="4" fill="rgba(255,255,255,0.9)"/>
                        </svg>
                        <div style="background: #111; border: 0.5px solid #333; color: white; font-size: 11px; font-weight: 600; padding: 4px 8px; border-radius: 6px; margin-top: 2px; white-space: nowrap;">${airport.name}</div>
                    </div>
                `,
                className: '',
                iconSize: [80, 60],
                iconAnchor: [40, 30]
            });
            airportMarker = L.marker([airport.lat, airport.lon], { icon: airportIcon }).addTo(map);
            
            // Clear all old aircraft data from the maps
            markers.forEach(m => map.removeLayer(m));
            trailLines.forEach(t => map.removeLayer(t));
            markers.clear();
            trails.clear();
            trailLines.clear();
            aircraftData.clear();
            
            // Hide the aircraft info box
            hideAircraftInfo();
            
            // Switch the ATC audio stream
            const audio = document.getElementById('audio');
            const control = document.getElementById('audio-control');
            const text = document.getElementById('audio-text');
            const wasPlaying = !audio.paused;
            audio.pause();
            audio.src = airport.audio; // Set the new audio source
            if (wasPlaying) {
                // If audio was on, play the new stream automatically
                audio.muted = true;
                audio.play().then(() => {
                    audio.muted = false;
                    text.textContent = 'ATC Live';
                }).catch(() => {});
            } else {
                text.textContent = 'Listen to ATC';
            }
        }

        /**
         * This is the core data function. It fetches new aircraft data
         * from the API every 2 seconds.
         */
        async function fetchAircraft() {
            try {
                const airport = AIRPORTS[currentAirport];
                // Fetch data from the API based on the current airport's location
                const response = await fetch(`https://api.airplanes.live/v2/point/${airport.lat}/${airport.lon}/50`);
                const data = await response.json();
                
                if (!data.ac) return; // Exit if there's no aircraft data
                
                const currentHexes = new Set(); // Keeps track of planes in this update
                
                data.ac.forEach(ac => {
                    // --- Filter out aircraft we don't want to see ---
                    const altitude = ac.alt_baro || ac.alt_geom || 0;
                    const isFlying = altitude > 100; // Filter out planes on the ground
                    
                    // Now we only filter out planes with bad data or on the ground.
                    if (!ac.lat || !ac.lon || ac.seen > 60 || !isFlying) return;
                    
                    currentHexes.add(ac.hex); // Add this plane to our "seen" list
                    aircraftData.set(ac.hex, ac); // Store its data
                    
                    
                    // --- Store the trail (path) data ---
                    // This creates a "fake" trail based on heading for new aircraft
                    // to make them appear with a trail instantly.
                    if (!trails.has(ac.hex)) {
                        trails.set(ac.hex, []); // Create a new trail if it's a new plane
                        const trail = trails.get(ac.hex);
                        const heading = (ac.track || 0) * Math.PI / 180;
                        const speed = (ac.gs || 400) * 0.000514444; // Rough speed conversion
                        for (let i = 1; i >= 0; i--) {
                            const timeBack = i * .5; 
                            const distBack = speed * timeBack;
                            const lat = ac.lat - (Math.cos(heading) * distBack);
                            const lon = ac.lon - (Math.sin(heading) * distBack);
                            trail.push([lat, lon]);
                        }
                    }
                    const trail = trails.get(ac.hex);
                    trail.push([ac.lat, ac.lon]); // Add the new position to the trail
                    if (trail.length > 200) trail.shift(); // Keep the trail from getting too long
                    
                    // Finally, call updateAircraft to draw/move the plane
                    updateAircraft(ac);
                });
                
                // Update the stats in the legend
                updateStats(currentHexes.size);
                
                // --- Clean up old aircraft ---
                // If a plane was in our `markers` list but not in `currentHexes`,
                // it means it has flown out of range and should be removed.
                markers.forEach((marker, hex) => {
                    if (!currentHexes.has(hex)) {
                        map.removeLayer(marker); // Remove icon
                        markers.delete(hex);
                        if (trailLines.has(hex)) {
                            map.removeLayer(trailLines.get(hex)); // Remove trail
                            trailLines.delete(hex);
                        }
                        trails.delete(hex);
                    }
                });
                
            } catch (error) {
                console.error('Error fetching aircraft data:', error);
            }
        }

        /**
         * Updates the text in the header ("X aircraft").
         */
        function updateStats(total) {
            // Update header count
            let countText;
            if (total === 0) {
                countText = '• Clear skies ✨';
            } else if (total === 1) {
                countText = '• 1 aircraft';
            } else {
                countText = `• ${total} aircraft`;
            }
            document.getElementById('aircraft-count').textContent = countText;
        }

        /**
         * This function is called for every single aircraft in every update.
         * It's responsible for drawing the icon, moving it, and updating its trail.
         */
        function updateAircraft(ac) {
            // If this plane is selected and 'Follow Mode' is on, move the map
            if (ac.hex === selectedAircraft && isFollowing) {
                map.panTo([ac.lat, ac.lon]);
            }

            const heading = ac.track || 0;
            
            // **** MODIFIED: Icon and Color Selection Logic ****
            const category = (ac.category || '').toUpperCase();
            let iconClass; // CSS class for the icon style (fill vs stroke)
            let trailClass; // CSS class for the trail color
            let iconHTML; // The actual HTML for the icon
            
            if (category === 'A7') { // A7 is Helicopter
                iconClass = 'icon-heli';
                trailClass = 'trail-heli';
                // Use the standard infinity symbol
                iconHTML = `<span class="icon-heli ${iconClass}" style="transform: rotate(${heading}deg); display:inline-block;">&infin;</span>`;
            
            } else {
                // All other types are planes
                let viewBox = '0 0 24 24'; // Default for planes
                
                if (category === 'A6') { // A6 is Military
                    iconClass = 'icon-mil';
                    trailClass = 'trail-mil';
                } else if (category === 'A1' || category === 'A2') { // A1/A2 is General Aviation
                    iconClass = 'icon-ga';
                    trailClass = 'trail-ga';
                } else if (category === 'A3' || category ==="A4" || category === 'A5') { // Commercial
                    iconClass = 'icon-comm';
                    trailClass = 'trail-comm';
                } else { // All others
                    iconClass = 'icon-other';
                    trailClass = 'trail-other';
                }
                
                // Use the airliner SVG path for all planes
                iconHTML = `<svg class="${iconClass}" width="28" height="28" viewBox="${viewBox}" style="transform: rotate(${heading}deg);">
                                <path d="${PATH_COMMERCIAL}"/>
                            </svg>`;
            }
            
            // Create the SVG icon for the plane
            const icon = L.divIcon({
                className: 'plane-marker',
                html: iconHTML,
                iconSize: [28, 28],
                iconAnchor: [14, 14] // Centers the icon
            });
            
            // If the plane is already on the map, just move its marker
            if (markers.has(ac.hex)) {
                const marker = markers.get(ac.hex);
                marker.setLatLng([ac.lat, ac.lon]);
                marker.setIcon(icon); // Also update icon in case heading/color/type changed
            } else {
                // If it's a new plane, create a new marker
                const marker = L.marker([ac.lat, ac.lon], { icon }).addTo(map);
                // Make the marker clickable to show the info box
                marker.on('click', () => {
                    const currentAc = aircraftData.get(ac.hex);
                    if (currentAc) showAircraftInfo(currentAc);
                });
                markers.set(ac.hex, marker); // Store the new marker
            }
            
            // Update the plane's trail
            updateTrail(ac, trailClass);
        }

        /**
         * Updates the visual trail line for a single aircraft.
         */
        function updateTrail(ac, trailClass) {
            const trail = trails.get(ac.hex);
            if (!trail || trail.length < 2) return; // Need at least 2 points to draw a line
            
            /*
             * MODIFICATION: TRAIL COLORS
             * These colors match the aircraft icon colors from the CSS.
             * If you change the CSS, change these hex codes to match.
            */
            const colors = {
                'trail-comm': '#0a84ff',  // Commercial (Blue)
                'trail-ga':   '#30d158',  // General Aviation (Green)
                'trail-mil':  '#ff375f',  // Military (Red)
                'trail-heli': '#ff9f0a',  // Helicopter (Orange)
                'trail-other':'#a2a2d2'   // Other/Unknown (Purple/Gray)
            };
            
            // If the trail line already exists, just update its path and style
            if (trailLines.has(ac.hex)) {
                const line = trailLines.get(ac.hex);
                line.setLatLngs(trail);
                line.setStyle({ 
                    color: colors[trailClass] || '#a2a2d2', // Default to 'other' color
                    opacity: 0.5,
                    weight: 2
                });
            } else {
                // If it's a new trail, create a new line object
                const line = L.polyline(trail, {
                    color: colors[trailClass] || '#a2a2d2',
                    weight: 2,
                    opacity: 0.5,
                    smoothFactor: 1
                }).addTo(map);
                trailLines.set(ac.hex, line); // Store the new line
            }
        }

        /**
         * Called when you click on an aircraft icon.
         * It shows the info box and enables "Follow Mode".
         */
        function showAircraftInfo(ac) {
            selectedAircraft = ac.hex;
            isFollowing = true; // Enable Follow Mode
            
            // Get all the data for the info box
            const callsign = ac.flight ? ac.flight.trim() : ac.hex.substring(0, 6).toUpperCase();
            const type = ac.t || 'Unknown';
            const altitude = Math.round(ac.alt_baro || ac.alt_geom || 0);
            const speed = Math.round((ac.gs || 0) * 1.15078); // Convert knots to mph
            
            // Determine the plane's status based on vertical rate and altitude
            const vert_rate = ac.baro_rate || ac.geom_rate || 0; 
            let status = 'Level';
            if (vert_rate > 350) {
                status = 'Climbing';
            } else if (vert_rate < -350) {
                status = 'Descending';
            } else if (altitude < 4000 && speed < 220) {
                status = 'Approach';
            } else if (speed > 450 && altitude > 25000) {
                status = 'Cruising';
            }
            
            // Fill in the HTML elements with the data
            document.getElementById('info-callsign').textContent = callsign;
            document.getElementById('info-type').textContent = type;
            document.getElementById('info-altitude').textContent = altitude.toLocaleString() + ' ft';
            document.getElementById('info-speed').textContent = speed + ' mph';
            document.getElementById('info-status').textContent = status;
            
            // Make the info box visible
            document.getElementById('aircraft-info').classList.add('visible');
            
            // Smoothly zoom/pan the map to the aircraft
            map.flyTo([ac.lat, ac.lon], 11, {
                duration: 0.8,
                easeLinearity: 0.25
            });
        }

        /**
         * Hides the aircraft info box and disables "Follow Mode".
         */
        function hideAircraftInfo() {
            isFollowing = false; // Disable Follow Mode
            selectedAircraft = null;
            document.getElementById('aircraft-info').classList.remove('visible');
        }

        /**
         * This function simply listens for a click on the map
         * (but not on a plane) to hide the info box.
         */
        function autoHideHeader() {
            map.on('click', (e) => {
                // If the click was on a plane icon, do nothing
                if (e.originalEvent.target.tagName === 'path' || e.originalEvent.target.tagName === 'SPAN') return;
                
                // Otherwise, hide the info box
                hideAircraftInfo();
            });
        }

        /**
         * Tries to automatically play the ATC audio on load (muted).
         * This is a workaround for browser autoplay restrictions.
         */
        function autoStartAudio() {
            const audio = document.getElementById('audio');
            const text = document.getElementById('audio-text');
            audio.src = AIRPORTS[currentAirport].audio;
            audio.muted = true; // Must be muted to autoplay
            audio.play().then(() => {
                // If autoplay succeeds, unmute after a short delay
                setTimeout(() => { 
                    audio.muted = false;
                    text.textContent = 'ATC Live';
                }, 500);
                document.getElementById('audio-control').classList.add('playing');
            }).catch(() => {
                // Autoplay was blocked by the browser.
                // The user will have to click the button manually.
            });
        }

        /**
         * Toggles the ATC audio on or off when the button is clicked.
         */
        function toggleAudio() {
            const audio = document.getElementById('audio');
            const control = document.getElementById('audio-control');
            const text = document.getElementById('audio-text');
            
            if (audio.paused) {
                audio.play();
                control.classList.add('playing');
                text.textContent = 'ATC Live';
            } else {
                audio.pause();
                control.classList.remove('playing');
                text.textContent = 'Listen to ATC';
            }
        }

        /**
         * Called when the "Recenter" button is clicked.
         * Moves the map back to the currently selected airport.
         */
        function recenterView() {
            isFollowing = false; // Disable Follow Mode
            const airport = AIRPORTS[currentAirport];
            map.flyTo([airport.lat, airport.lon], airport.zoom, {
                duration: 1,
                easeLinearity: 0.25
            });
            hideAircraftInfo(); // Hide the info box
        }

        /**
         * Starts the main data fetch loop.
         * We run an initial fetch cycle to build up trails,
         * then start the regular 2-second interval.
         */
        function startTracking() {
            // This helper function fetches data multiple times on load
            // to build up the trails immediately.
            const buildTrails = async () => {
                for (let i = 0; i < 5; i++) {
                    await fetchAircraft();
                    // Wait 2 seconds between fetches to get new data points
                    await new Promise(resolve => setTimeout(resolve, 2000));
                }
            };
            
            // Run the trail-building function first...
            buildTrails().then(() => {
                // ...and *then* start the regular 2-second update interval.
                // MODIFICATION: You can change `2000` to a different number
                // (in milliseconds) to fetch more or less frequently.
                setInterval(fetchAircraft, 2000);
            });
        }

        // --- SECTION 3: START THE APP ---

        // This is the only function called automatically.
        // It starts the entire application.
        init();
    </script>
</body>
</html>